import{_ as G,a as z}from"./uoDSKYA2.js";import{f as F,z as Y,g as Q,r as s,s as X,h as R,i as Z,j as ee,o as C,w as S,a as _,b as y,k as te,d as w,c as oe,l as ne,p as k,m as p,q as se,n as re,_ as ae}from"./BEMtwttk.js";import{g as le,v as ie,w as U,m as ce}from"./COO27srU.js";import{C as de,a as q,g as N,b as ue}from"./uzHwbF_c.js";import"./DwpP0FTx.js";import{c as pe,b as ye}from"./BjWuQ266.js";import"./Dg19p0Ij.js";const me={class:"flex items-center gap-0"},ge={key:0},x="Testnet",fe=F({__name:"create-identity",setup(ve){const a=Y("showLoader"),V=Q();s({}),s(""),s(""),s(""),s(0),s(""),s({}),s(""),s(null);const l=s(""),m=s(!1),j=s(!1),v=s([]),h=s(0);s({});const I={walletProxyBaseUrl:"https://wallet-proxy.testnet.concordium.com",grpcPort:2e4,grpcUrl:"https://grpc.testnet.concordium.com"},b=I.grpcUrl,T=I.grpcPort,A=I.walletProxyBaseUrl;console.log({nodeAddress:b});const B=new de(b,T),O=()=>{localStorage.clear()};X(async()=>{a.value=!0;const t=await M();a.value=!1,localStorage.setItem("ip-info",JSON.stringify(t)),v.value=t});const L=async()=>{O();const t=le(U,256);localStorage.setItem("seed-phrase",t),l.value=t,m.value=!0},P=async()=>{const t=l.value,e=ie(t,U);localStorage.setItem("seed-phrase",t),console.log(e),e?(console.log("Valid seed phrase"),m.value=!0):(console.log("Invalid seed phrase"),m.value=!1)},M=async()=>(await fetch(A+"/v1/ip_info")).json(),i=R(()=>v.value[h.value]),D=R(()=>{const t=localStorage.getItem("identity-objects");let e=[];return t?e=JSON.parse(t):e=[],e.length}),J=t=>Math.min(t-1,255),$=async(t,e)=>{try{const n={scope:"identity",response_type:"code",redirect_uri:N(),state:JSON.stringify({idObjectRequest:t})},o=new URLSearchParams(n),r=`${e}?${o.toString()}`,u=await fetch(r);if(u.redirected)return u.url;throw new Error("The identity provider did not redirect as expected.")}catch(n){return console.log(n.message),alert("An error occurred while sending the identity request. Maybe identity exists already. Try Recover Account"),null}},H=async()=>{try{a.value=!0;const t=q.fromSeedPhrase(l.value,x),e=i.value.ipInfo.ipIdentity,n=D.value,o=t.getIdCredSec(e,n).toString("hex"),r=t.getPrfKey(e,n).toString("hex"),u=await B.getCryptographicParameters(),g=t.getSignatureBlindingRandomness(e,n).toString("hex"),c={arsInfos:i.value.arsInfos,arThreshold:J(Object.keys(i.value.arsInfos).length),ipInfo:i.value.ipInfo,globalContext:u,idCredSec:o,prfKey:r,blindingRandomness:g};console.log("...........trying to create identity request");const d=pe(c),f=await $(d,i.value.metadata.issuanceStart);if(f==null){alert("An error occurred while sending the identity request. Maybe identity exists already. Try Recover Account");return}f?.includes(N())?window.alert("An error occurred during the identity creation."):window.open(f,"_blank")}catch(t){console.log(t)}finally{a.value=!1}};Z(()=>V.fullPath,()=>{l.value=localStorage.getItem("seed-phrase")||"",m.value=l.value.length>0,m.value&&P()},{immediate:!0});const K=async t=>{a.value=!0,P();const e=E();Promise.all([e]).then(()=>{a.value=!1;const n=JSON.parse(localStorage.getItem("identity-objects")||"[]");let o;n.length>0?o="Recovery successful. You can now create account with the recovered identity.":o="No identity found to recover for IDP"+i.value.metadata.support+". Please check your seed and try again.",console.log(o),alert(o)}).catch(n=>{console.error(n),a.value=!1})};function W(t){const e=ce(t);return Array.from(e).map(n=>n.toString(16).padStart(2,"0")).join("")}const E=async()=>{j.value=!1,i.value.ipInfo.ipIdentity;const t=await ue();let e=[];q.fromSeedPhrase(l.value,x);const n=W(l.value);console.log({seedHex:n});for(let o=0;o<=21;o++){const r={ipInfo:i.value.ipInfo,globalContext:t,timestamp:Math.floor(Date.now()/1e3),seedAsHex:n,net:x,identityIndex:o};console.log({identityRequestInput:r}),console.log("...........trying to create identity recovery request for identityIndex: "+o);const u=ye(r),g=new URLSearchParams({state:JSON.stringify({idRecoveryRequest:u})}),c=`${i.value.metadata.recoveryStart}?${g.toString()}`;try{const d=await fetch(c);if(d.ok){const f=await d.json();e.push(f.value)}else console.error("Failed to recover identity:",d.statusText)}catch(d){console.error(d),console.log("continuing... identityIndex = "+o)}}localStorage.setItem("identity-objects",JSON.stringify(e,(o,r)=>typeof r=="bigint"?Number(r):r))};return(t,e)=>{const n=G,o=se,r=z,u=te,g=re;return C(),ee(g,null,{default:S(()=>[_("div",me,[y(u,{style:{width:"100%"}},{default:S(()=>[e[3]||(e[3]=w(" IDP Seed: ",-1)),y(n,{modelValue:p(l),"onUpdate:modelValue":e[0]||(e[0]=c=>k(l)?l.value=c:null)},null,8,["modelValue"]),y(o,{type:"success",onClick:L,disabled:p(a)},{default:S(()=>[...e[2]||(e[2]=[w("Generate",-1)])]),_:1},8,["disabled"]),e[4]||(e[4]=_("br",null,null,-1)),e[5]||(e[5]=_("br",null,null,-1)),p(v).length>0?(C(),oe("h4",ge," Select an IDP: ")):ne("",!0),y(r,{modelValue:p(h),"onUpdate:modelValue":e[1]||(e[1]=c=>k(h)?h.value=c:null),options:p(v).map((c,d)=>({label:c.ipInfo.ipDescription.name,value:d})),label:"Select Identity Provider"},null,8,["modelValue","options"]),y(o,{label:"Create Identity",onClick:H,disabled:p(a)},null,8,["disabled"]),e[6]||(e[6]=w(" / ",-1)),y(o,{label:"Recover Identity",onClick:K,disabled:p(a)},null,8,["disabled"])]),_:1})])]),_:1})}}}),Pe=ae(fe,[["__scopeId","data-v-6e5a1564"]]);export{Pe as default};
